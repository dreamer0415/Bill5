import React, { useState, useRef, useEffect } from 'react';
import { 
  Upload, 
  FileText, 
  Edit2, 
  Trash2, 
  Copy, 
  Download, 
  Loader2, 
  X,
  CheckCircle2,
  AlertCircle,
  Heart
} from 'lucide-react';

const apiKey = ""; // 系統自動注入

const InvoiceAssistant = () => {
  const [invoices, setInvoices] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [editingInvoice, setEditingInvoice] = useState(null);
  const [statusMsg, setStatusMsg] = useState({ type: '', text: '' });
  const fileInputRef = useRef(null);

  // 顯示訊息提示
  const showMessage = (text, type = 'success') => {
    setStatusMsg({ text, type });
    setTimeout(() => setStatusMsg({ text: '', type: '' }), 3000);
  };

  // 呼叫 Gemini API 進行辨識
  const recognizeInvoice = async (base64Data) => {
    const prompt = "請辨識這張發票的細節，並以 JSON 格式回傳，包含以下欄位：date (YYYY/MM/DD), invoiceNumber (發票號碼), storeName (商店名稱), amount (總金額，僅數字)。如果辨識不到請填空字串。";
    
    const payload = {
      contents: [{
        parts: [
          { text: prompt },
          { inlineData: { mimeType: "image/png", data: base64Data } }
        ]
      }],
      generationConfig: {
        responseMimeType: "application/json",
      }
    };

    const fetchWithRetry = async (retries = 5, delay = 1000) => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error('API request failed');
        return await response.json();
      } catch (error) {
        if (retries > 0) {
          await new Promise(res => setTimeout(res, delay));
          return fetchWithRetry(retries - 1, delay * 2);
        }
        throw error;
      }
    };

    const result = await fetchWithRetry();
    const textResult = result.candidates?.[0]?.content?.parts?.[0]?.text;
    return JSON.parse(textResult);
  };

  // 處理檔案上傳
  const handleFileUpload = async (e) => {
    const files = Array.from(e.target.files || e.dataTransfer.files);
    if (files.length === 0) return;

    setIsProcessing(true);
    const newInvoices = [];

    for (const file of files) {
      try {
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });
        
        const base64Data = await base64Promise;
        const data = await recognizeInvoice(base64Data);
        
        newInvoices.push({
          id: crypto.randomUUID(),
          date: data.date || '',
          invoiceNumber: data.invoiceNumber || '',
          storeName: data.storeName || '',
          amount: data.amount || 0,
          rawImage: `data:${file.type};base64,${base64Data}`
        });
      } catch (error) {
        console.error("Error processing file:", error);
        showMessage("辨識部分發票時發生錯誤", "error");
      }
    }

    setInvoices(prev => [...prev, ...newInvoices]);
    setIsProcessing(false);
    if (fileInputRef.current) fileInputRef.current.value = "";
  };

  // 編輯相關功能
  const openEditModal = (invoice) => setEditingInvoice({ ...invoice });
  const closeEditModal = () => setEditingInvoice(null);
  
  const handleSaveEdit = () => {
    setInvoices(prev => prev.map(inv => inv.id === editingInvoice.id ? editingInvoice : inv));
    closeEditModal();
    showMessage("資料已甜美更新！");
  };

  const deleteInvoice = (id, e) => {
    e.stopPropagation();
    setInvoices(prev => prev.filter(inv => inv.id !== id));
    showMessage("已移除該筆發票", "info");
  };

  // 複製表格內容
  const copyTableToClipboard = () => {
    if (invoices.length === 0) return;
    const header = "日期\t發票號碼\t商店名稱\t總金額\n";
    const body = invoices.map(inv => `${inv.date}\t${inv.invoiceNumber}\t${inv.storeName}\t${inv.amount}`).join('\n');
    const text = header + body;
    
    const textArea = document.createElement("textarea");
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    showMessage("已複製到剪貼簿囉！");
  };

  // 匯出 CSV
  const exportToCSV = () => {
    if (invoices.length === 0) return;
    const header = "\uFEFF日期,發票號碼,商店名稱,總金額\n";
    const body = invoices.map(inv => `${inv.date},${inv.invoiceNumber},${inv.storeName},${inv.amount}`).join('\n');
    const blob = new Blob([header + body], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `馬卡龍發票清單_${new Date().toLocaleDateString()}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showMessage("CSV 檔案下載成功");
  };

  return (
    <div className="min-h-screen bg-[#FEF9F2] p-4 md:p-8 font-sans text-[#5D576B]">
      {/* 標題區域 */}
      <header className="mb-10 text-center">
        <div className="inline-block bg-white px-8 py-4 rounded-full shadow-sm mb-4 border-2 border-[#FFB7B2]/30">
          <h1 className="text-4xl md:text-5xl font-black text-[#FF9AA2] tracking-tight">發票小助手</h1>
        </div>
        <p className="text-[#A7A2B0] font-medium flex items-center justify-center gap-2">
          用馬卡龍的心情整理生活 <Heart size={16} className="fill-[#FFB7B2] text-[#FFB7B2]" />
        </p>
      </header>

      <main className="max-w-5xl mx-auto space-y-8">
        {/* 上傳區域 */}
        <div 
          className={`relative border-4 border-dashed rounded-[2.5rem] p-12 transition-all flex flex-col items-center justify-center bg-white cursor-pointer
            ${isProcessing ? 'border-[#B2CEFE] opacity-70' : 'border-[#FFD1DC] hover:border-[#FF9AA2] hover:bg-[#FFF9F9] hover:scale-[1.01]'}`}
          onDragOver={(e) => { e.preventDefault(); e.currentTarget.classList.add('border-[#FF9AA2]'); }}
          onDragLeave={(e) => e.currentTarget.classList.remove('border-[#FF9AA2]')}
          onDrop={(e) => { e.preventDefault(); e.currentTarget.classList.remove('border-[#FF9AA2]'); handleFileUpload(e); }}
          onClick={() => !isProcessing && fileInputRef.current.click()}
        >
          <input 
            type="file" 
            multiple 
            accept="image/*" 
            className="hidden" 
            ref={fileInputRef} 
            onChange={handleFileUpload} 
          />
          {isProcessing ? (
            <div className="flex flex-col items-center">
              <Loader2 className="w-16 h-16 text-[#FF9AA2] animate-spin mb-4" />
              <p className="text-lg font-bold text-[#FF9AA2]">正在烘焙辨識結果...</p>
            </div>
          ) : (
            <div className="flex flex-col items-center text-center">
              <div className="w-24 h-24 bg-[#FFF0F0] rounded-full flex items-center justify-center mb-6 shadow-inner">
                <Upload className="w-10 h-10 text-[#FF9AA2]" />
              </div>
              <p className="text-2xl font-bold text-[#5D576B]">點擊或拖放照片</p>
              <p className="text-[#A7A2B0] mt-3 font-medium">支援多張上傳，讓整理像吃甜點一樣簡單</p>
            </div>
          )}
        </div>

        {/* 狀態提示 */}
        {statusMsg.text && (
          <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full shadow-2xl flex items-center gap-3 animate-bounce z-50 text-white font-bold ${
            statusMsg.type === 'error' ? 'bg-[#FF6B6B]' : statusMsg.type === 'info' ? 'bg-[#A2D2FF]' : 'bg-[#B9FBC0] text-[#4A7C59]'
          }`}>
            {statusMsg.type === 'error' ? <AlertCircle size={22} /> : <CheckCircle2 size={22} />}
            <span>{statusMsg.text}</span>
          </div>
        )}

        {/* 工具列 */}
        {invoices.length > 0 && (
          <div className="flex flex-wrap items-center justify-between gap-4 px-4">
            <h2 className="text-2xl font-black flex items-center gap-3 text-[#5D576B]">
              <div className="p-2 bg-[#E2F0CB] rounded-xl"><FileText className="text-[#89A45E]" /></div>
              辨識清單
            </h2>
            <div className="flex gap-3">
              <button 
                onClick={copyTableToClipboard}
                className="flex items-center gap-2 px-6 py-3 bg-white border-2 border-[#E8E1EF] text-[#5D576B] rounded-2xl hover:bg-[#F7F2FA] transition-all shadow-sm font-bold active:scale-95"
              >
                <Copy size={18} /> 複製
              </button>
              <button 
                onClick={exportToCSV}
                className="flex items-center gap-2 px-6 py-3 bg-[#B9FBC0] text-[#4A7C59] rounded-2xl hover:bg-[#A3EBB0] transition-all shadow-lg shadow-[#B9FBC0]/40 font-bold active:scale-95"
              >
                <Download size={18} /> 匯出 CSV
              </button>
            </div>
          </div>
        )}

        {/* 發票表格 */}
        <div className="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-[#E8E1EF] overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-[#FAF7FF] text-[#A7A2B0] text-sm uppercase font-black">
                  <th className="px-8 py-5 border-b border-[#F0EAF7]">日期</th>
                  <th className="px-8 py-5 border-b border-[#F0EAF7]">發票號碼</th>
                  <th className="px-8 py-5 border-b border-[#F0EAF7]">商店名稱</th>
                  <th className="px-8 py-5 border-b border-[#F0EAF7]">金額</th>
                  <th className="px-8 py-5 border-b border-[#F0EAF7] text-center">操作</th>
                </tr>
              </thead>
              <tbody>
                {invoices.length === 0 ? (
                  <tr>
                    <td colSpan="5" className="px-8 py-24 text-center">
                      <div className="flex flex-col items-center opacity-40">
                        <Heart size={48} className="text-[#FFD1DC] mb-4" />
                        <p className="text-xl font-bold text-[#A7A2B0]">期待您的第一張發票...</p>
                      </div>
                    </td>
                  </tr>
                ) : (
                  invoices.map((inv) => (
                    <tr 
                      key={inv.id} 
                      onClick={() => openEditModal(inv)}
                      className="group hover:bg-[#FFF9F9] cursor-pointer transition-colors"
                    >
                      <td className="px-8 py-5 border-b border-[#FAF7FF] font-medium">{inv.date || '---'}</td>
                      <td className="px-8 py-5 border-b border-[#FAF7FF] font-mono text-[#FF9AA2] font-bold">{inv.invoiceNumber || '---'}</td>
                      <td className="px-8 py-5 border-b border-[#FAF7FF]">{inv.storeName || '---'}</td>
                      <td className="px-8 py-5 border-b border-[#FAF7FF]">
                        <span className="bg-[#FFFFD1] px-3 py-1 rounded-lg font-black text-[#85854E]">${inv.amount}</span>
                      </td>
                      <td className="px-8 py-5 border-b border-[#FAF7FF] text-center">
                        <div className="flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                          <div className="p-2 text-[#B2CEFE] hover:text-[#769FCD] hover:bg-white rounded-full shadow-sm transition-all">
                            <Edit2 size={18} />
                          </div>
                          <button 
                            onClick={(e) => deleteInvoice(inv.id, e)}
                            className="p-2 text-[#FFB7B2] hover:text-[#FF6B6B] hover:bg-white rounded-full shadow-sm transition-all"
                          >
                            <Trash2 size={18} />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </main>

      {/* 編輯 Modal */}
      {editingInvoice && (
        <div className="fixed inset-0 bg-[#5D576B]/40 backdrop-blur-md flex items-center justify-center p-4 z-[60] animate-in fade-in duration-300">
          <div className="bg-white rounded-[3rem] shadow-2xl w-full max-w-md overflow-hidden transform animate-in zoom-in-95 duration-300 border-4 border-[#FFD1DC]/20">
            <div className="flex items-center justify-between p-8 border-b border-[#FAF7FF] bg-[#FFF9F9]">
              <h3 className="text-2xl font-black text-[#FF9AA2]">編輯小確幸</h3>
              <button onClick={closeEditModal} className="p-2 hover:bg-[#FFD1DC] rounded-full transition-colors text-[#FF9AA2]">
                <X size={24} />
              </button>
            </div>
            
            <div className="p-8 space-y-5">
              {editingInvoice.rawImage && (
                <div className="w-full h-36 rounded-[2rem] overflow-hidden mb-2 border-4 border-[#FFF0F0] shadow-inner">
                  <img src={editingInvoice.rawImage} alt="Invoice preview" className="w-full h-full object-cover" />
                </div>
              )}
              
              <div className="space-y-2">
                <label className="text-xs font-black text-[#A7A2B0] uppercase ml-2">消費日期</label>
                <input 
                  type="text" 
                  value={editingInvoice.date}
                  onChange={(e) => setEditingInvoice({...editingInvoice, date: e.target.value})}
                  className="w-full px-6 py-3 bg-[#FAF7FF] border-2 border-[#E8E1EF] rounded-2xl focus:border-[#FFB7B2] outline-none transition-all font-bold"
                  placeholder="YYYY/MM/DD"
                />
              </div>

              <div className="space-y-2">
                <label className="text-xs font-black text-[#A7A2B0] uppercase ml-2">發票號碼</label>
                <input 
                  type="text" 
                  value={editingInvoice.invoiceNumber}
                  onChange={(e) => setEditingInvoice({...editingInvoice, invoiceNumber: e.target.value})}
                  className="w-full px-6 py-3 bg-[#FAF7FF] border-2 border-[#E8E1EF] rounded-2xl focus:border-[#FFB7B2] outline-none transition-all font-mono font-bold text-[#FF9AA2]"
                  placeholder="AB-12345678"
                />
              </div>

              <div className="space-y-2">
                <label className="text-xs font-black text-[#A7A2B0] uppercase ml-2">商店名稱</label>
                <input 
                  type="text" 
                  value={editingInvoice.storeName}
                  onChange={(e) => setEditingInvoice({...editingInvoice, storeName: e.target.value})}
                  className="w-full px-6 py-3 bg-[#FAF7FF] border-2 border-[#E8E1EF] rounded-2xl focus:border-[#FFB7B2] outline-none transition-all font-bold"
                />
              </div>

              <div className="space-y-2">
                <label className="text-xs font-black text-[#A7A2B0] uppercase ml-2">總金額</label>
                <div className="relative">
                  <span className="absolute left-6 top-1/2 -translate-y-1/2 text-[#85854E] font-bold">$</span>
                  <input 
                    type="number" 
                    value={editingInvoice.amount}
                    onChange={(e) => setEditingInvoice({...editingInvoice, amount: e.target.value})}
                    className="w-full pl-10 pr-6 py-3 bg-[#FFFFD1] border-2 border-[#E8E1EF] rounded-2xl focus:border-[#FFB7B2] outline-none transition-all font-black text-[#85854E]"
                  />
                </div>
              </div>
            </div>

            <div className="p-8 bg-[#FAF7FF] border-t border-[#F0EAF7] flex gap-4">
              <button 
                onClick={closeEditModal}
                className="flex-1 py-4 px-6 rounded-2xl border-2 border-[#E8E1EF] font-black text-[#A7A2B0] hover:bg-white transition-colors"
              >
                先不要
              </button>
              <button 
                onClick={handleSaveEdit}
                className="flex-1 py-4 px-6 rounded-2xl bg-[#FFB7B2] text-white font-black hover:bg-[#FF9AA2] transition-all shadow-lg shadow-[#FFB7B2]/30 active:scale-95"
              >
                確認儲存
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default InvoiceAssistant;
